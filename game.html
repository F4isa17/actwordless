<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>صفحة اللعب</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=El+Messiri:wght@400;600;700&family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4A6572;
      --accent: #F9AA33;
      --dark: #232F34;
      --bg: #f5f7f9;
      --card: #ffffff;
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
    }
    body {
      margin: 0;
      font-family: 'Tajawal', sans-serif;
      background: var(--bg);
      color: var(--dark);
      position: relative;
      overflow-x: hidden;
      overflow-y: auto;
    }
    .side-ad {
      position: absolute;
      top: 115px !important;
      width: 125px;
      height: 800px;
      background: rgba(255, 255, 255, 0.8);
      border: 2px solid rgba(249, 170, 51, 0.35);
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #4A6572;
      pointer-events: none;
      z-index: 2;
    }
    .side-ad-left { left: 2px !important; }
    .side-ad-right { right: 2px !important; }
    .banner-ad {
      width: 1550px;
      height: 75px;
      max-width: calc(100% - 32px);
      margin: 9px auto 32px;
      background: rgba(255, 255, 255, 0.8);
      border: 2px solid rgba(249, 170, 51, 0.35);
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #4A6572;
      pointer-events: none;
    }
    @media (max-width: 1200px) {
      .side-ad { display: none; }
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url('Actwordless10.jpg') center/cover no-repeat;
      opacity: 0.42;
      pointer-events: none;
      z-index: -1;
    }
    .bg-watermark {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 0;
    }
    .bg-watermark .logo-section {
      display: flex;
      align-items: center;
      gap: 16px;
      opacity: 0.18;
      transform: scale(1.6) rotate(-8deg);
    }
    .bg-watermark .logo {
      width: 110px;
      height: 110px;
      background: #F9AA33;
      border-radius: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 60px;
      box-shadow: 0 6px 20px rgba(249, 170, 51, 0.35);
    }
    .bg-watermark .site-title {
      font-family: 'El Messiri', cursive;
      font-size: 80px;
      font-weight: 700;
      color: #4A6572;
      margin: 0;
    }
    .bg-watermark .site-title span {
      color: #F9AA33;
    }
    header, main, .modal-overlay {
      position: relative;
      z-index: 1;
    }
    .topbar {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 8px;
      padding: 12px 18px;
      background: #232F34;
      color: #fff;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.18);
      border-bottom: 2px solid rgba(249, 170, 51, 0.25);
    }
    .team-panel {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #1d262b;
      padding: 8px 12px;
      border-radius: 999px;
      border: 2px solid rgba(249, 170, 51, 0.35);
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
    }
    .team-name {
      font-weight: 700;
      color: #fff;
      font-size: 1.15rem;
      white-space: nowrap;
    }
    .action-inline {
      font-size: 1.15rem;
      padding: 6px 12px;
    }
    .team-left-wrap {
      display: flex;
      align-items: center;
      gap: 18px;
      justify-content: flex-start;
    }
    .team-score {
      font-size: 1.1rem;
      font-weight: 800;
      background: var(--accent);
      color: #fff;
      padding: 4px 10px;
      border-radius: 10px;
      min-width: 40px;
      text-align: center;
    }
    .center-title {
      text-align: center;
      font-family: 'El Messiri', cursive;
      font-size: 1.4rem;
      font-weight: 700;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      flex-wrap: wrap;
      justify-self: center;
    }
    #teamRight { justify-self: start; }
    .team-left-wrap { justify-self: end; }
    .title-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #gameTitle {
      font-size: 1.15rem;
      font-weight: 700;
    }
    .turn-badge {
      background: #1d262b;
      color: #fff;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 1.1rem;
      font-weight: 700;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      border: 1px solid rgba(249, 170, 51, 0.45);
    }
    .action-btn {
      background: #F9AA33;
      color: #232F34;
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-weight: 800;
      font-family: inherit;
      font-size: 0.95rem;
      line-height: 1.2;
      cursor: pointer;
    }
    main {
      max-width: 1600px;
      margin: 8px auto;
      padding: 0 16px 24px;
      display: grid;
      gap: 16px;
    }
    .card {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      padding: 16px;
    }
    .meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .meta div {
      background: #f1f3f5;
      border-radius: 12px;
      padding: 12px;
    }
    .list {
      margin: 0;
      padding: 0 18px;
    }
    .timer {
      text-align: center;
      font-size: 2.4rem;
      font-weight: 700;
      color: var(--primary);
      font-family: monospace;
    }
    .actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-weight: 800;
      font-family: inherit;
      font-size: 1.15rem;
      line-height: 1.2;
      cursor: pointer;
      background: var(--accent);
      color: #fff;
    }
    .btn.secondary { background: #e9ecef; color: var(--dark); }
    .btn.active {
      background: #F9AA33;
      color: #232F34;
      box-shadow: 0 0 0 3px rgba(249, 170, 51, 0.35);
    }
    .rules-launch {
      display: flex;
      justify-content: center;
    }
    .rules-launch-btn {
      background: var(--primary);
      color: #fff;
      border: 4px solid rgba(249, 170, 51, 0.6);
      border-radius: 24px;
      padding: 10px 18px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.18);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .rules-launch-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.2);
    }
    .rules-launch-btn span {
      font-size: 1rem;
    }
    .rules-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 60;
    }
    .rules-modal.active {
      display: flex;
    }
    .rules-modal-card {
      background: #fff;
      width: 100%;
      max-width: 900px;
      max-height: 85vh;
      border-radius: 20px;
      border: 2px solid rgba(52, 73, 85, 0.25);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .rules-modal-header {
      background: var(--primary);
      color: #fff;
      padding: 16px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .rules-modal-title {
      font-family: 'El Messiri', cursive;
      font-size: 1.4rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .rules-close {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .rules-close:hover {
      background: rgba(255, 255, 255, 0.35);
    }
    .rules-tabs {
      display: flex;
      gap: 8px;
      padding: 10px 16px;
      border-bottom: 1px solid rgba(52, 73, 85, 0.2);
      background: #f7f9fa;
      overflow-x: auto;
    }
    .rules-tab {
      border: none;
      background: transparent;
      color: #344955;
      padding: 10px 16px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .rules-tab.active {
      background: var(--accent);
      color: #232F34;
    }
    .rules-body {
      padding: 16px 18px;
      overflow-y: auto;
      flex: 1;
    }
    .rules-panel {
      display: none;
    }
    .rules-panel.active {
      display: block;
    }
    .rules-note {
      background: rgba(74, 101, 114, 0.08);
      border: 1px solid rgba(74, 101, 114, 0.2);
      border-radius: 16px;
      padding: 12px 14px;
      margin-bottom: 14px;
    }
    .rules-note h4 {
      margin: 0 0 6px;
      font-size: 1rem;
      color: var(--primary);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .rules-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }
    .rules-card {
      border-radius: 16px;
      padding: 14px;
      border: 1px solid rgba(52, 73, 85, 0.2);
      background: #fff;
    }
    .rules-card h4 {
      margin: 0 0 10px;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #232F34;
    }
    .rules-card.success {
      border-color: rgba(46, 125, 50, 0.4);
      background: #eaf7ef;
    }
    .rules-card.warning {
      border-color: rgba(249, 170, 51, 0.6);
      background: #fff4e0;
    }
    .rules-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 8px;
    }
    .rules-list li {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      font-size: 0.98rem;
    }
    .rules-list i {
      color: var(--accent);
      margin-top: 2px;
    }
    .rules-footer {
      border-top: 1px solid rgba(52, 73, 85, 0.2);
      padding: 12px 16px;
      background: #f7f9fa;
      display: flex;
      justify-content: flex-end;
    }
    .rules-confirm {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-weight: 700;
      cursor: pointer;
    }
    .results-overlay {
      position: fixed;
      inset: 0;
      background: rgba(17, 24, 39, 0.78);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 10000;
    }
    .results-overlay.active {
      display: flex;
    }
    .results-card {
      background: #ffffff;
      width: 100%;
      max-width: 960px;
      border-radius: 28px;
      border: 2px solid rgba(74, 101, 114, 0.2);
      box-shadow: 0 28px 60px rgba(0, 0, 0, 0.25);
      padding: 36px 32px 30px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .results-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(249, 170, 51, 0.18), transparent 60%);
      pointer-events: none;
    }
    .results-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 18px;
      border-radius: 999px;
      background: linear-gradient(90deg, #f9aa33, #ffd27a);
      color: #232F34;
      font-weight: 800;
      box-shadow: 0 10px 18px rgba(249, 170, 51, 0.3);
      margin-bottom: 10px;
    }
    .results-title {
      font-family: 'El Messiri', cursive;
      font-size: 2.6rem;
      color: var(--primary);
      margin: 6px 0 4px;
    }
    .results-subtitle {
      color: #455a64;
      font-weight: 600;
      margin-bottom: 20px;
    }
    .results-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 18px;
      margin-bottom: 22px;
      position: relative;
      z-index: 1;
    }
    .results-team {
      border-radius: 20px;
      padding: 22px 20px;
      background: #f8fafc;
      border: 2px solid #e5e7eb;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.6);
    }
    .results-team.winner {
      border-color: rgba(46, 125, 50, 0.6);
      background: linear-gradient(135deg, rgba(46, 125, 50, 0.16), rgba(46, 125, 50, 0.02));
    }
    .results-team.loser {
      border-color: rgba(198, 40, 40, 0.6);
      background: linear-gradient(135deg, rgba(198, 40, 40, 0.16), rgba(198, 40, 40, 0.02));
    }
    .results-team.tie {
      border-color: rgba(74, 101, 114, 0.5);
      background: linear-gradient(135deg, rgba(74, 101, 114, 0.16), rgba(74, 101, 114, 0.02));
    }
    .results-tag {
      font-weight: 800;
      color: #344955;
      margin-bottom: 6px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .results-name {
      font-size: 1.6rem;
      font-weight: 800;
      color: #232F34;
    }
    .results-score {
      font-size: 2.6rem;
      font-weight: 900;
      margin-top: 8px;
      color: #232F34;
    }
    .results-actions {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
      position: relative;
      z-index: 1;
    }
    .results-actions .btn {
      border-radius: 16px;
      padding: 10px 18px;
      font-size: 1.05rem;
    }
    .results-sparkles {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 0;
    }
    .results-sparkles span {
      position: absolute;
      color: #f9aa33;
      opacity: 0.85;
      animation: floatSpark 4.8s ease-in-out infinite;
    }
    .results-sparkles span:nth-child(1) { top: 18px; left: 22px; font-size: 18px; animation-delay: 0s; }
    .results-sparkles span:nth-child(2) { top: 40px; right: 32px; font-size: 22px; animation-delay: 0.6s; }
    .results-sparkles span:nth-child(3) { bottom: 30px; left: 40px; font-size: 16px; animation-delay: 1.2s; }
    .results-sparkles span:nth-child(4) { bottom: 24px; right: 44px; font-size: 20px; animation-delay: 1.8s; }
    .results-sparkles span:nth-child(5) { top: 120px; left: 50%; font-size: 14px; animation-delay: 2.4s; }
    @keyframes floatSpark {
      0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.85; }
      50% { transform: translateY(-10px) rotate(8deg); opacity: 1; }
    }
    @media (max-width: 768px) {
      .rules-launch-btn {
        width: 100%;
        justify-content: center;
      }
      .rules-modal-card {
        max-height: 90vh;
      }
      .results-grid {
        grid-template-columns: 1fr;
      }
      .results-title {
        font-size: 2.1rem;
      }
      .results-score {
        font-size: 2.1rem;
      }
    }
    .empty {
      text-align: center;
      padding: 40px 16px;
      color: #666;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(5, minmax(190px, 1fr));
      gap: 12px;
      position: relative;
      z-index: 1;
    }
    .tile {
      background: #435D69;
      border-radius: 14px;
      padding: 16px;
      min-height: 170px;
      font-size: 1.5rem;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-weight: 700;
      color: #fff;
      border: 2px solid #e8ecef;
      box-shadow: 0 4px 14px rgba(0,0,0,0.06);
      cursor: pointer;
    }
    .tile-content {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .tile-number {
      font-size: 2.6rem;
      font-weight: 900;
      color: #fff;
      z-index: 2;
    }
    .tile-brand {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 10px;
      opacity: 0.07;
      justify-content: center;
    }
    .tile-brand .logo-section {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .tile-brand .logo {
      width: 55px;
      height: 55px;
      background: #F9AA33;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 30px;
      box-shadow: 0 4px 12px rgba(249, 170, 51, 0.35);
    }
    .tile-brand .site-title {
      font-family: 'El Messiri', cursive;
      font-size: 36px;
      font-weight: 700;
      color: #fff;
      margin: 0;
    }
    .tile-brand .site-title span {
      color: #F9AA33;
    }
    .tile-title span {
      color: #F9AA33;
    }
    .tile.muted {
      color: #999;
      font-weight: 600;
      border-style: dashed;
    }
    .tile.used {
      background: #f1f1f1;
      color: #999;
      border-color: #e0e0e0;
      cursor: not-allowed;
      opacity: 0.7;
    }
    .tile.used .tile-number {
      color: #000;
    }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    .modal-overlay.active { display: flex; }
    .modal-card {
      background: #f4f6f7;
      border-radius: 18px;
      padding: 38px 42px 36px;
      width: 100%;
      max-width: 720px;
      text-align: center;
      box-shadow: 0 18px 40px rgba(0,0,0,0.2);
      color: #232F34;
    }
    .modal-timer {
      font-size: 2rem;
      font-weight: 800;
      color: #b1552b;
      margin: 6px 0 12px;
      font-family: monospace;
      display: block;
    }
    .modal-timer-wrap {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-bottom: 18px;
    }
    .modal-timer-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .modal-timer-note {
      text-align: center;
      font-size: 0.95rem;
      color: #232F34;
      background: rgba(249, 170, 51, 0.15);
      border: 1px solid rgba(249, 170, 51, 0.35);
      padding: 8px 12px;
      border-radius: 12px;
      width: 100%;
      max-width: 420px;
    }
    .timer-display-container {
      text-align: center;
      width: 450px;
      height: 150px;
      margin: 0 auto;
      padding: 12px;
      background: linear-gradient(145deg, #f0f7ff 0%, #e3f2fd 100%);
      border-radius: 12px;
      border: 2px dashed #4A6572;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      padding-top: 10px;
    }
    .duration-label {
      font-weight: 700;
      color: #4A6572;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .timer-display {
      width: 422px;
      height: 108px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 70px;
      font-weight: 800;
      color: #4A6572;
      font-family: monospace;
    }
    .modal-word {
      font-size: 2.2rem;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 28px;
    }
    .modal-image {
      background: #f3f4f6;
      border-radius: 12px;
      padding: 30px;
      color: #666;
      margin-bottom: 28px;
      width: 636px;
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    .modal-image img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: none;
    }
    .modal-image .modal-image-fallback {
      display: block;
      font-weight: 700;
    }
    .modal-placeholder {
      background: #f8fafc;
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      margin-bottom: 28px;
      width: 636px;
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 10px;
      color: #4A6572;
    }
    .modal-placeholder i {
      font-size: 2.2rem;
      color: #F9AA33;
    }
    .modal-placeholder span {
      font-weight: 700;
    }
    .modal-placeholder .btn {
      margin-top: 10px;
    }
    .modal-placeholder.compact {
      height: auto;
      min-height: 0;
      padding: 0;
      border: none;
      background: transparent;
      margin-bottom: 14px;
    }
    .modal-placeholder.compact i,
    .modal-placeholder.compact span {
      display: none;
    }
    .modal-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 18px;
    }
    .modal-actions.reveal-actions {
      margin-top: 6px;
      margin-bottom: 14px;
    }
    .modal-actions .btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      filter: grayscale(0.2);
    }
    .btn.success { background: #2e7d32; }
    .btn.danger { background: #c62828; }
    .reveal-hint {
      display: none;
    }
    .btn.reveal-pulse {
      animation: revealPulse 1.1s ease-in-out infinite;
      box-shadow: 0 0 0 0 rgba(249, 170, 51, 0.7), 0 0 14px rgba(249, 170, 51, 0.85);
      border: 2px solid rgba(249, 170, 51, 0.9);
      filter: brightness(1.05);
    }
    @keyframes revealPulse {
      0% {
        transform: translateY(0);
        box-shadow: 0 0 0 0 rgba(249, 170, 51, 0.7), 0 0 14px rgba(249, 170, 51, 0.85);
      }
      70% {
        transform: translateY(-2px);
        box-shadow: 0 0 0 16px rgba(249, 170, 51, 0), 0 0 18px rgba(249, 170, 51, 0.95);
      }
      100% {
        transform: translateY(0);
        box-shadow: 0 0 0 0 rgba(249, 170, 51, 0), 0 0 14px rgba(249, 170, 51, 0.85);
      }
    }
  </style>
</head>
<body>
  <div class="side-ad side-ad-left" aria-hidden="true">إعلان</div>
  <div class="side-ad side-ad-right" aria-hidden="true">إعلان</div>
  <div class="bg-watermark">
    <div class="logo-section">
      <div class="logo">
        <i class="fas fa-theater-masks"></i>
      </div>
      <h1 class="site-title">Act<span>Wordless</span></h1>
    </div>
  </div>

  <header class="topbar">
    <div class="team-panel" id="teamRight">
      <div class="team-name" id="teamOneName">الفريق الأول</div>
      <div class="team-score" id="scoreTeamOne">0</div>
    </div>
    <div class="center-title">
      <div class="title-row">
        <div id="gameTitle">صفحة اللعب</div>
      </div>
      <div class="turn-badge">
        <span>دور الفريق: </span>
        <span id="turnName">-</span>
      </div>
    </div>
    <div class="team-left-wrap">
      <div class="team-panel" id="teamLeft">
        <div class="team-name" id="teamTwoName">الفريق الثاني</div>
        <div class="team-score" id="scoreTeamTwo">0</div>
      </div>
      <div class="team-panel">
        <button class="action-btn action-inline" id="btnEnd">إنهاء</button>
        <button class="action-btn action-inline" id="btnExit">خروج</button>
      </div>
    </div>
  </header>

  <main id="gameRoot">
    <div class="rules-launch">
      <button class="rules-launch-btn" id="rulesBtn" type="button" aria-haspopup="dialog" aria-controls="rulesModal">
        <i class="fas fa-book-open"></i>
        <span>قوانين اللعبة</span>
      </button>
    </div>
    <div class="board" id="wordBoard"></div>
  </main>
  <div class="banner-ad" aria-hidden="true">إعلان</div>

  <div class="modal-overlay" id="wordModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-placeholder" id="modalPlaceholder">
        <i class="fas fa-eye"></i>
        <span>اضغط إظهار للعرض</span>
        <button class="btn secondary" id="btnToggleReveal">إظهار</button>
      </div>
      <div class="modal-word" id="modalWord">كلمة</div>
      <div class="modal-image" id="modalImage">
        <img id="modalImageEl" alt="">
        <span class="modal-image-fallback">لا توجد صورة لهذه الكلمة</span>
      </div>
      <div class="modal-timer-wrap" id="modalTimerWrap">
        <div class="timer-display-container">
          <div class="duration-label">
            <i class="fas fa-clock"></i>
            الوقت :
          </div>
          <div class="timer-display" id="modalTimer">00:00</div>
        </div>
        <div class="modal-timer-note" id="modalTimerNote">إذا كنت جاهز اضغط زر التشغيل</div>
      <div class="modal-timer-actions">
          <button class="btn secondary" id="btnTimerStart">تشغيل</button>
          <button class="btn secondary" id="btnTimerPause">تعليق</button>
      </div>
      </div>
      <div class="modal-actions">
        <button class="btn success" id="btnCorrect">جاوبتوا صح</button>
        <button class="btn danger" id="btnSkip">صعبة عليكم!</button>
      </div>
    </div>
  </div>

  <div class="rules-modal" id="rulesModal" aria-hidden="true">
    <div class="rules-modal-card" role="dialog" aria-modal="true" aria-labelledby="rulesModalTitle">
      <div class="rules-modal-header">
        <div class="rules-modal-title" id="rulesModalTitle">
          <i class="fas fa-book-open"></i>
          قوانين اللعبة
        </div>
        <button class="rules-close" type="button" id="rulesClose" aria-label="إغلاق">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="rules-tabs" role="tablist">
        <button class="rules-tab active" type="button" data-tab="play" role="tab" aria-selected="true">
          <i class="fas fa-book-open"></i>
          طريقة اللعب
        </button>
        <button class="rules-tab" type="button" data-tab="time" role="tab" aria-selected="false">
          <i class="fas fa-clock"></i>
          الوقت والنقاط
        </button>
        
      </div>
      <div class="rules-body">
        <div class="rules-panel active" data-panel="play">
          <div class="rules-note">
            <h4><i class="fas fa-info-circle"></i> معلومة مهمة</h4>
            <p>كل فريق يلعب السؤال الخاص فيه من غير مشاركة الفريق الآخر.</p>
            <p>اضغط إظهار لإظهار الكلمة.</p>
            <p>جهّز نفسك قبل ما تضغط تشغيل للمؤقت.</p>
          </div>
          <div class="rules-grid">
            <div class="rules-card success">
              <h4><i class="fas fa-check-circle"></i> الفريق اللي عليه الدور</h4>
              <ul class="rules-list">
                <li><i class="fas fa-chevron-left"></i><span>ترشيح شخص من الفريق علشان يقوم ويمثل.</span></li>
                <li><i class="fas fa-chevron-left"></i><span>اختيار السؤال يكون بشكل عشوائي من الأسئلة المتاحة.</span></li>
                <li><i class="fas fa-chevron-left"></i><span>الشخص اللي راح يمثل لازم يكون صامت ويمثل بالإشارة فقط.</span></li>
                <li><i class="fas fa-chevron-left"></i><span>الشخص اللي يمثل يحرص على إن الفم يكون مغلق.</span></li>
              </ul>
            </div>
            <div class="rules-card warning">
              <h4><i class="fas fa-exclamation-circle"></i> الفريق الضد</h4>
              <ul class="rules-list">
                <li><i class="fas fa-chevron-left"></i><span>الالتزام بالصمت طوال فترة التمثيل للفريق الآخر.</span></li>
                <li><i class="fas fa-chevron-left"></i><span>أي تعطيل للفريق الآخر تُحسب النقاط ضده.</span></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="rules-panel" data-panel="time">
          <div class="rules-grid">
            <div class="rules-card">
              <h4><i class="fas fa-clock"></i> المؤقت</h4>
              <ul class="rules-list">
                <li><i class="fas fa-chevron-left"></i><span>يمكن تشغيل المؤقت أو إيقافه حسب إعداداتك.</span></li>
                <li><i class="fas fa-chevron-left"></i><span>عند انتهاء الوقت يعتمد على الإعداد: إذا كان الإغلاق التلقائي مفعّل ينتهي الدور، وإذا كان ملغي القرار لكم.</span></li>
                <li><i class="fas fa-chevron-left"></i><span>يجب مراقبة الوقت بشكل جيد إذا كان إغلاق الكلمة تلقائيًا عند انتهاء الوقت مُفعّل.</span></li>
              </ul>
            </div>
            <div class="rules-card">
              <h4><i class="fas fa-star"></i> احتساب النقاط</h4>
              <ul class="rules-list">
                <li><i class="fas fa-chevron-left"></i><span>"جاوبتوا صح" يزيد نقطة للفريق الحالي.</span></li>
                <li><i class="fas fa-chevron-left"></i><span>"صعبة عليكم" ينهي الدور بدون نقاط.</span></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="rules-footer">
        <button class="rules-confirm" type="button" id="rulesConfirm">تم الفهم</button>
      </div>
    </div>
  </div>

  <div class="results-overlay" id="resultsOverlay" aria-hidden="true">
    <div class="results-card">
      <div class="results-sparkles" aria-hidden="true">
        <span><i class="fas fa-star"></i></span>
        <span><i class="fas fa-star"></i></span>
        <span><i class="fas fa-star"></i></span>
        <span><i class="fas fa-star"></i></span>
        <span><i class="fas fa-star"></i></span>
      </div>
      <div class="results-badge" id="resultsBadge">
        <i class="fas fa-trophy"></i>
        <span>مبروك</span>
      </div>
      <div class="results-title" id="resultsTitle">الفائز</div>
      <div class="results-subtitle" id="resultsSubtitle">أداء رائع من الفريقين!</div>
      <div class="results-grid">
        <div class="results-team winner" id="winnerCard">
          <div class="results-tag" id="winnerTag">
            <i class="fas fa-crown"></i>
            <span>الفائز</span>
          </div>
          <div class="results-name" id="winnerName">-</div>
          <div class="results-score" id="winnerScore">0</div>
        </div>
        <div class="results-team loser" id="loserCard">
          <div class="results-tag" id="loserTag">
            <i class="fas fa-face-frown"></i>
            <span>هاردلك</span>
          </div>
          <div class="results-name" id="loserName">-</div>
          <div class="results-score" id="loserScore">0</div>
        </div>
      </div>
      <div class="results-actions">
        <button class="btn" id="btnNewGame">لعبة جديدة</button>
        <button class="btn secondary" id="btnBackHome">الصفحة الرئيسية</button>
      </div>
    </div>
  </div>

  <script>
    const root = document.getElementById('gameRoot');
    const boardEl = document.getElementById('wordBoard');
    const title = document.getElementById('gameTitle');
    const modal = document.getElementById('wordModal');
    const modalWord = document.getElementById('modalWord');
    const modalTimer = document.getElementById('modalTimer');
    const modalTimerWrap = document.getElementById('modalTimerWrap');
    const btnTimerStart = document.getElementById('btnTimerStart');
    const btnTimerPause = document.getElementById('btnTimerPause');
    const modalTimerNote = document.getElementById('modalTimerNote');
    const modalPlaceholder = document.getElementById('modalPlaceholder');
    const modalImage = document.getElementById('modalImage');
    const modalImageEl = document.getElementById('modalImageEl');
    const modalImageFallback = modalImage ? modalImage.querySelector('.modal-image-fallback') : null;
    const btnToggleReveal = document.getElementById('btnToggleReveal');
    const btnCorrect = document.getElementById('btnCorrect');
    const btnSkip = document.getElementById('btnSkip');
    const btnEnd = document.getElementById('btnEnd');
    const btnExit = document.getElementById('btnExit');
    const rulesBtn = document.getElementById('rulesBtn');
    const rulesModal = document.getElementById('rulesModal');
    const rulesClose = document.getElementById('rulesClose');
    const rulesConfirm = document.getElementById('rulesConfirm');
    const rulesTabs = document.querySelectorAll('.rules-tab');
    const rulesPanels = document.querySelectorAll('.rules-panel');
    const resultsOverlay = document.getElementById('resultsOverlay');
    const resultsBadge = document.getElementById('resultsBadge');
    const resultsTitle = document.getElementById('resultsTitle');
    const resultsSubtitle = document.getElementById('resultsSubtitle');
    const winnerCard = document.getElementById('winnerCard');
    const loserCard = document.getElementById('loserCard');
    const winnerTag = document.getElementById('winnerTag');
    const loserTag = document.getElementById('loserTag');
    const winnerName = document.getElementById('winnerName');
    const loserName = document.getElementById('loserName');
    const winnerScore = document.getElementById('winnerScore');
    const loserScore = document.getElementById('loserScore');
    const btnNewGame = document.getElementById('btnNewGame');
    const btnBackHome = document.getElementById('btnBackHome');
    const teamOneNameEl = document.getElementById('teamOneName');
    const teamTwoNameEl = document.getElementById('teamTwoName');
    const scoreTeamOneEl = document.getElementById('scoreTeamOne');
    const scoreTeamTwoEl = document.getElementById('scoreTeamTwo');
    const turnNameEl = document.getElementById('turnName');

    const TIMER_SETTINGS_KEY = 'actwordless_timer_settings';
    const GAME_COMPLETED_KEY = 'actwordless_game_completed';
    let data = null;
    try {
      data = JSON.parse(localStorage.getItem('actwordless_game_data'));
    } catch (e) {
      data = null;
    }
    if (!data) {
      try {
        const rawState = localStorage.getItem('actwordless_game_state');
        if (rawState) {
          const state = JSON.parse(rawState);
          if (state && typeof state === 'object') {
            data = {
              name: 'صفحة اللعب',
              teamOne: state.teamOne,
              teamTwo: state.teamTwo,
              categories: Array.isArray(state.categories) ? state.categories : [],
              timerEnabled: false,
              timerAutoClose: false,
              timerDuration: 90
            };
            try {
              localStorage.setItem('actwordless_game_data', JSON.stringify(data));
            } catch (e) {
              // ignore storage errors
            }
          }
        }
      } catch (e) {
        data = null;
      }
    }
    let timerEnabled = !!(data && (data.timerEnabled === true || data.timerEnabled === 'true'));
    let isAutoCloseOnTimeout = !!(data && (data.timerAutoClose === true || data.timerAutoClose === 'true'));

    const IMAGE_BASE_PATH = 'assets';
    const IMAGE_EXTENSIONS = ['.webp', '.png', '.jpg', '.jpeg'];

    const categoryMap = {
      1: { name: 'مسرحيات', words: ['مدرسة المشاغبين','شاهد ما شفش حاجة','العيال كبرت','المتزوجون','سك على بناتك','ريا وسكينة','الواد سيد الشغال','الزعيم','الدلوعة','حرام عليكم'] },
      2: { name: 'أغاني أجنبية', words: ['Imagine','Billie Jean','Shape of You','Hello','Rolling in the Deep','Despacito','Bad Romance','Happy','Blinding Lights','Uptown Funk'] },
      3: { name: 'أغاني خليجية', words: ['ياليالي','يا سلام','أحبك','ما أقدر أنساك','جلسة طرب','يا زين','على بالي','انت خطير','وينك','يا حبيبي'] },
      4: { name: 'أغاني عربية', words: ['سيرة الحب','أم كلثوم','حبيبي يا نور العين','يا حياتي','يا طير','أماكن في القلب','لو سألوك','على بالي','أنا قلبي ليك','حلوة يا بلدي'] },
      5: { name: 'أفلام أجنبية', words: ['Titanic','Inception','The Matrix','Avatar','The Godfather','Interstellar','Gladiator','The Dark Knight','Forrest Gump','Home Alone'] },
      6: { name: 'أفلام عربية', words: ['الكيت كات','عمارة يعقوبيان','الإرهابي','مرجان أحمد مرجان','الجزيرة','الفيل الأزرق','عسل أسود','الكنز','تيتة رهيبة','أمير البحار'] },
      7: { name: 'مسلسلات أجنبية', words: ['Friends','Breaking Bad','Game of Thrones','Money Heist','Stranger Things','The Office','Sherlock','The Witcher','Squid Game','Dark'] },
      8: { name: 'مسلسلات خليجية', words: ['طاش ما طاش','العاصوف','ساهر الليل','أميمة في دار الأيتام','خمس بنات','سوق الحريم','خاتم','من الآخر','دبي لندن دبي','أهل الدار'] },
      9: { name: 'مسلسلات عربية', words: ['باب الحارة','الاختيار','الهيبة','لن أعيش في جلباب أبي','رأفت الهجان','ليالي الحلمية','الكبير أوي','طريقي','نصيبي وقسمتك','المواطن إكس'] },
      10:{ name: 'مشاهير أجانب', words: ['توم كروز','أنجلينا جولي','براد بيت','كريستيانو رونالدو','ليونيل ميسي','بيونسيه','جاستن بيبر','تايلور سويفت','إد شيران','روبرت داوني جونيور'] },
      11:{ name: 'مشاهير عرب', words: ['عادل إمام','نانسي عجرم','عمرو دياب','إليسا','أحمد زكي','محمد رمضان','أحلام','راشد الماجد','فيروز','صباح'] },
      12:{ name: 'دول', words: ['السعودية','مصر','الإمارات','قطر','الكويت','المغرب','الجزائر','تونس','لبنان','الأردن'] },
      13:{ name: 'لاعبين عرب', words: ['محمد صلاح','رياض محرز','أشرف حكيمي','سالم الدوسري','ياسين بونو','سفيان بوفال','علي الحبسي','ياسر القحطاني','أبو تريكة','وليد عبدالله'] },
      14:{ name: 'لاعبين أجانب', words: ['ليونيل ميسي','كريستيانو رونالدو','كيليان مبابي','إيرلينغ هالاند','نيمار','لوكا مودريتش','كيفين دي بروين','كانتي','فينيسيوس جونيور','روبرت ليفاندوفسكي'] }
    };

    const USED_WORDS_KEY = 'actwordless_used_words_v1';

    function loadUsedWords() {
      try {
        const raw = localStorage.getItem(USED_WORDS_KEY);
        if (!raw) return {};
        const data = JSON.parse(raw);
        return data && typeof data === 'object' ? data : {};
      } catch (e) {
        return {};
      }
    }

    function saveUsedWords(store) {
      try {
        localStorage.setItem(USED_WORDS_KEY, JSON.stringify(store));
      } catch (e) {
        console.error('Failed to save used words:', e);
      }
    }

    function getUsedSet(store, categoryId) {
      const key = String(categoryId);
      const list = Array.isArray(store[key]) ? store[key] : [];
      if (!Array.isArray(store[key])) store[key] = list;
      return new Set(list);
    }

    function setUsedSet(store, categoryId, set) {
      store[String(categoryId)] = Array.from(set);
    }

    function buildWordCategoryIndex(ids) {
      const map = new Map();
      ids.forEach(id => {
        const entry = categoryMap[id];
        if (!entry || !Array.isArray(entry.words)) return;
        entry.words.forEach(word => {
          if (!map.has(word)) map.set(word, id);
        });
      });
      return map;
    }

    function getUnusedPool(ids, usedStore) {
      const pool = [];
      ids.forEach(id => {
        const entry = categoryMap[id];
        if (!entry || !Array.isArray(entry.words)) return;
        const usedSet = getUsedSet(usedStore, id);
        entry.words.forEach(word => {
          if (!usedSet.has(word)) {
            pool.push({ word, categoryId: id });
          }
        });
      });
      return pool;
    }

    function markPickedWordsUsed(usedStore, picked) {
      picked.forEach(item => {
        const set = getUsedSet(usedStore, item.categoryId);
        set.add(item.word);
        setUsedSet(usedStore, item.categoryId, set);
      });
      saveUsedWords(usedStore);
    }

    function resetUsedForCategories(usedStore, ids) {
      ids.forEach(id => {
        usedStore[String(id)] = [];
      });
    }

    function markWordsUsedFromBoard(usedStore, wordIndex, words) {
      words.forEach(word => {
        const id = wordIndex.get(word);
        if (!id) return;
        const set = getUsedSet(usedStore, id);
        set.add(word);
        setUsedSet(usedStore, id, set);
      });
      saveUsedWords(usedStore);
    }

    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        const tmp = a[i];
        a[i] = a[j];
        a[j] = tmp;
      }
      return a;
    }

    let currentTurn = 'teamOne';
    let scoreTeamOne = 0;
    let scoreTeamTwo = 0;
    let isRevealed = true;
    let hasRevealedOnce = false;
    let activeTile = null;
    let boardWords = [];
    let usedTiles = [];
    let wordCategoryIndex = new Map();
    let isGameFinished = false;

    function getStateKey() {
      return 'actwordless_game_state';
    }

    function saveState() {
      if (!data) return;
      const state = {
        teamOne: data.teamOne,
        teamTwo: data.teamTwo,
        categories: data.categories,
        boardWords: boardWords,
        usedTiles: usedTiles,
        scoreTeamOne: scoreTeamOne,
        scoreTeamTwo: scoreTeamTwo,
        currentTurn: currentTurn
      };
      try {
        localStorage.setItem(getStateKey(), JSON.stringify(state));
      } catch (e) {
        console.error('Failed to save state:', e);
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(getStateKey());
        if (!raw) return null;
        const state = JSON.parse(raw);
        // Basic check to ensure state matches current game data
        if (!data) return null;
        const sameTeams = state.teamOne === data.teamOne && state.teamTwo === data.teamTwo;
        const sameCategories = Array.isArray(state.categories) &&
          JSON.stringify(state.categories) === JSON.stringify(data.categories || []);
        if (!sameTeams || !sameCategories) return null;
        return state;
      } catch (e) {
        return null;
      }
    }

    function updateTurnUI() {
      turnNameEl.textContent = currentTurn === 'teamOne' ? (teamOneNameEl.textContent || '-') : (teamTwoNameEl.textContent || '-');
    }

    function setAnswerButtonsEnabled(enabled) {
      if (btnCorrect) btnCorrect.disabled = !enabled;
      if (btnSkip) btnSkip.disabled = !enabled;
    }

    function buildImageCandidates(word, categoryId) {
      const categoryName = categoryMap[categoryId] ? categoryMap[categoryId].name : String(categoryId);
      const folder = encodeURIComponent(categoryName);
      const filename = encodeURIComponent(word);
      return IMAGE_EXTENSIONS.map(ext => `${IMAGE_BASE_PATH}/${folder}/${filename}${ext}`);
    }

    function setModalImageForWord(word) {
      if (!modalImageEl) return;
      const categoryId = wordCategoryIndex.get(word);
      if (!categoryId) {
        modalImageEl.style.display = 'none';
        if (modalImageFallback) modalImageFallback.style.display = 'block';
        return;
      }
      const candidates = buildImageCandidates(word, categoryId);
      let index = 0;

      const showFallback = () => {
        modalImageEl.style.display = 'none';
        if (modalImageFallback) modalImageFallback.style.display = 'block';
      };

      const tryNext = () => {
        if (index >= candidates.length) {
          showFallback();
          return;
        }
        modalImageEl.src = candidates[index++];
      };

      modalImageEl.onload = () => {
        modalImageEl.style.display = 'block';
        if (modalImageFallback) modalImageFallback.style.display = 'none';
      };
      modalImageEl.onerror = () => {
        tryNext();
      };
      tryNext();
    }

    function refreshTimerSettings() {
      let source = data;
      let settings = null;
      try {
        const raw = localStorage.getItem('actwordless_game_data');
        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === 'object') {
            source = parsed;
          }
        }
      } catch (e) {
        // ignore storage errors
      }
      try {
        const rawSettings = localStorage.getItem(TIMER_SETTINGS_KEY);
        if (rawSettings) {
          const parsedSettings = JSON.parse(rawSettings);
          if (parsedSettings && typeof parsedSettings === 'object') {
            settings = parsedSettings;
          }
        }
      } catch (e) {
        // ignore storage errors
      }

      const enabledRaw = settings && Object.prototype.hasOwnProperty.call(settings, 'timerEnabled')
        ? settings.timerEnabled
        : (source && source.timerEnabled);
      const autoCloseRaw = settings && Object.prototype.hasOwnProperty.call(settings, 'timerAutoClose')
        ? settings.timerAutoClose
        : (source && source.timerAutoClose);
      const durationRaw = settings && Object.prototype.hasOwnProperty.call(settings, 'timerDuration')
        ? settings.timerDuration
        : (source && source.timerDuration);

      timerEnabled = !!(enabledRaw === true || enabledRaw === 'true');
      isAutoCloseOnTimeout = !!(autoCloseRaw === true || autoCloseRaw === 'true');
      const duration = parseInt(durationRaw || 90, 10);
      return { timerDuration: Number.isNaN(duration) ? 90 : duration };
    }

    function applyTimerModeUi() {
      if (modalTimerNote) {
        modalTimerNote.style.display = isAutoCloseOnTimeout ? 'block' : 'none';
      }
      if (btnTimerPause) {
        btnTimerPause.style.display = isAutoCloseOnTimeout ? 'none' : 'inline-flex';
      }
    }

    function openRulesModal() {
      if (!rulesModal) return;
      rulesModal.classList.add('active');
      rulesModal.setAttribute('aria-hidden', 'false');
    }

    function closeRulesModal() {
      if (!rulesModal) return;
      rulesModal.classList.remove('active');
      rulesModal.setAttribute('aria-hidden', 'true');
    }

    function setRulesTab(tabId) {
      rulesTabs.forEach(tab => {
        const isActive = tab.dataset.tab === tabId;
        tab.classList.toggle('active', isActive);
        tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      rulesPanels.forEach(panel => {
        panel.classList.toggle('active', panel.dataset.panel === tabId);
      });
    }

    function updateScores() {
      scoreTeamOneEl.textContent = String(scoreTeamOne);
      scoreTeamTwoEl.textContent = String(scoreTeamTwo);
    }

    function getPlayableCount() {
      return boardWords.reduce((count, word) => count + (word ? 1 : 0), 0);
    }

    function getUsedCount() {
      return usedTiles.reduce((count, used, idx) => count + (boardWords[idx] ? (used ? 1 : 0) : 0), 0);
    }

    function openResults() {
      if (!resultsOverlay) return;
      isGameFinished = true;
      try {
        localStorage.setItem(GAME_COMPLETED_KEY, 'true');
        localStorage.removeItem('actwordless_game_data');
        localStorage.removeItem(getStateKey());
      } catch (e) {
        // Ignore storage errors
      }

      const teamOneName = teamOneNameEl.textContent || 'الفريق الأول';
      const teamTwoName = teamTwoNameEl.textContent || 'الفريق الثاني';
      const teamOneScore = scoreTeamOne;
      const teamTwoScore = scoreTeamTwo;

      if (teamOneScore === teamTwoScore) {
        resultsBadge.innerHTML = '<i class="fas fa-handshake"></i><span>تعادل</span>';
        resultsTitle.textContent = 'تعادل';
        resultsSubtitle.textContent = 'كل فريق قدم أداء رائع!';
        winnerCard.classList.remove('winner', 'loser');
        loserCard.classList.remove('winner', 'loser');
        winnerCard.classList.add('tie');
        loserCard.classList.add('tie');
        winnerTag.innerHTML = '<i class="fas fa-users"></i><span>الفريق الأول</span>';
        loserTag.innerHTML = '<i class="fas fa-users"></i><span>الفريق الثاني</span>';
        winnerName.textContent = teamOneName;
        loserName.textContent = teamTwoName;
        winnerScore.textContent = String(teamOneScore);
        loserScore.textContent = String(teamTwoScore);
      } else {
        const winnerIsTeamOne = teamOneScore > teamTwoScore;
        resultsBadge.innerHTML = '<i class="fas fa-trophy"></i><span>مبروك</span>';
        resultsTitle.textContent = 'الفائز';
        resultsSubtitle.textContent = 'هاردلك للفريق الآخر، جولة قوية!';

        winnerCard.classList.remove('tie', 'loser');
        loserCard.classList.remove('tie', 'winner');
        winnerCard.classList.add('winner');
        loserCard.classList.add('loser');

        winnerTag.innerHTML = '<i class="fas fa-crown"></i><span>الفائز</span>';
        loserTag.innerHTML = '<i class="fas fa-face-frown"></i><span>هاردلك</span>';

        winnerName.textContent = winnerIsTeamOne ? teamOneName : teamTwoName;
        loserName.textContent = winnerIsTeamOne ? teamTwoName : teamOneName;
        winnerScore.textContent = String(winnerIsTeamOne ? teamOneScore : teamTwoScore);
        loserScore.textContent = String(winnerIsTeamOne ? teamTwoScore : teamOneScore);
      }

      resultsOverlay.classList.add('active');
      resultsOverlay.setAttribute('aria-hidden', 'false');
    }

    function checkForGameEnd() {
      if (isGameFinished) return;
      const totalPlayable = getPlayableCount();
      if (!totalPlayable) return;
      const usedCount = getUsedCount();
      if (usedCount >= totalPlayable) {
        openResults();
      }
    }

    if (!data) {
      root.innerHTML = '<div class="card empty">ما فيه بيانات لعبة. ارجع للصفحة الرئيسية واختر الفئات ثم ابدأ.</div>';
    } else {
      title.textContent = data.name || 'صفحة اللعب';
      teamOneNameEl.textContent = data.teamOne || 'الفريق الأول';
      teamTwoNameEl.textContent = data.teamTwo || 'الفريق الثاني';
      const selectedIds = Array.isArray(data.categories) ? data.categories : [];
      const usedStore = loadUsedWords();
      wordCategoryIndex = buildWordCategoryIndex(selectedIds);

      const saved = loadState();
      if (saved && Array.isArray(saved.boardWords) && saved.boardWords.length) {
        boardWords = saved.boardWords;
        usedTiles = Array.isArray(saved.usedTiles) ? saved.usedTiles : [];
        scoreTeamOne = saved.scoreTeamOne || 0;
        scoreTeamTwo = saved.scoreTeamTwo || 0;
        currentTurn = saved.currentTurn === 'teamTwo' ? 'teamTwo' : 'teamOne';
        markWordsUsedFromBoard(usedStore, wordCategoryIndex, boardWords);
      } else {
        let pool = shuffle(getUnusedPool(selectedIds, usedStore));
        if (pool.length === 0) {
          resetUsedForCategories(usedStore, selectedIds);
          saveUsedWords(usedStore);
          pool = shuffle(getUnusedPool(selectedIds, usedStore));
        }
        const picked = pool.slice(0, 20);
        boardWords = picked.map(item => item.word);
        usedTiles = new Array(20).fill(false);
        if (picked.length) {
          markPickedWordsUsed(usedStore, picked);
        }
      }

      boardEl.innerHTML = '';
      for (let i = 0; i < 20; i++) {
        const tile = document.createElement('button');
        tile.type = 'button';
        tile.className = 'tile';
        tile.innerHTML = `
          <div class="tile-content">
            <div class="tile-number">${i + 1}</div>
            <div class="tile-brand">
              <div class="logo-section">
                <div class="logo">
                  <i class="fas fa-theater-masks"></i>
                </div>
                <h1 class="site-title">Act<span>Wordless</span></h1>
              </div>
            </div>
          </div>
        `;
        if (!boardWords[i]) tile.classList.add('muted');
        if (usedTiles[i]) {
          tile.classList.add('used');
          tile.disabled = true;
        }
        tile.addEventListener('click', () => {
          if (!boardWords[i]) return;
          if (tile.classList.contains('used')) return;
          activeTile = tile;
          activeTile.dataset.index = String(i);
          modalWord.textContent = boardWords[i];
          setModalImageForWord(boardWords[i]);
          isRevealed = false;
          hasRevealedOnce = false;
          if (modalPlaceholder) {
            modalPlaceholder.style.display = 'flex';
            modalPlaceholder.classList.remove('compact');
          }
          modalWord.style.display = 'none';
          modalImage.style.display = 'none';
          btnToggleReveal.textContent = 'إظهار';
          setAnswerButtonsEnabled(false);
          btnToggleReveal.classList.add('reveal-pulse');
          resetModalTimer();
          modal.classList.add('active');
          modal.setAttribute('aria-hidden', 'false');
        });
        boardEl.appendChild(tile);
      }
      updateTurnUI();
      updateScores();
      saveState();
    }

    // Modal timer (only if enabled in settings)
    let modalInterval = null;
    let modalTimeLeft = 0;
    let modalRunning = false;
    let audioCtx = null;

    function playBeep(freq = 900, duration = 0.12) {
      try {
        if (!audioCtx) {
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (!Ctx) return;
          audioCtx = new Ctx();
        }
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.value = freq;
        gain.gain.value = 0.08;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
      } catch (e) {
        // ignore audio errors
      }
    }
    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
    }
    function resetModalTimer() {
      const source = refreshTimerSettings();
      if (!timerEnabled) {
        modalTimerWrap.style.display = 'none';
        if (modalInterval) {
          clearInterval(modalInterval);
          modalInterval = null;
        }
        modalRunning = false;
        return;
      }
      modalTimerWrap.style.display = 'flex';
      modalTimeLeft = parseInt((source && source.timerDuration) || 90, 10);
      modalTimer.textContent = formatTime(modalTimeLeft);
      modalRunning = false;
      btnTimerStart.disabled = false;
      if (btnTimerPause) btnTimerPause.disabled = true;
      btnTimerStart.classList.remove('active');
      if (btnTimerPause) btnTimerPause.classList.remove('active');
      if (modalInterval) {
        clearInterval(modalInterval);
        modalInterval = null;
      }
      applyTimerModeUi();
    }

    function startModalTimer() {
      refreshTimerSettings();
      if (!timerEnabled) return;
      if (modalRunning) return;
      modalRunning = true;
      btnTimerStart.disabled = true;
      if (modalTimerNote) modalTimerNote.style.display = 'none';
      if (btnTimerPause) btnTimerPause.disabled = false;
      btnTimerStart.classList.add('active');
      if (btnTimerPause) btnTimerPause.classList.remove('active');
      if (modalInterval) clearInterval(modalInterval);
      modalInterval = setInterval(() => {
        modalTimeLeft -= 1;
        if (modalTimeLeft <= 0) {
          modalTimeLeft = 0;
          clearInterval(modalInterval);
          modalRunning = false;
          btnTimerStart.disabled = true;
          if (btnTimerPause) btnTimerPause.disabled = true;
          playBeep(520, 0.4);
          if (isAutoCloseOnTimeout) {
            setTimeout(() => {
              if (modal.classList.contains('active')) {
                handleSkip();
              }
            }, 150);
          }
        }
      modalTimer.textContent = formatTime(modalTimeLeft);
      if (modalTimeLeft > 0 && modalTimeLeft <= 5) {
        playBeep(900, 0.12);
      }
    }, 1000);
  }

  function pauseModalTimer() {
    if (!modalRunning) return;
    modalRunning = false;
    if (modalInterval) {
      clearInterval(modalInterval);
      modalInterval = null;
    }
    btnTimerStart.disabled = false;
    if (btnTimerPause) btnTimerPause.disabled = true;
    btnTimerStart.classList.remove('active');
    if (btnTimerPause) btnTimerPause.classList.add('active');
  }


    function closeWordModal() {
      if (modalInterval) {
        clearInterval(modalInterval);
        modalInterval = null;
      }
      modalRunning = false;
      activeTile = null;
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden', 'true');
    }
    modal.addEventListener('click', (e) => {
      if (e.target === modal) return;
    });

    btnToggleReveal.addEventListener('click', () => {
      isRevealed = !isRevealed;
      if (modalPlaceholder) {
        modalPlaceholder.classList.toggle('compact', isRevealed);
      }
      modalWord.style.display = isRevealed ? 'block' : 'none';
      modalImage.style.display = isRevealed ? 'flex' : 'none';
      btnToggleReveal.textContent = isRevealed ? 'إخفاء' : 'إظهار';
      if (isRevealed) {
        hasRevealedOnce = true;
        btnToggleReveal.classList.remove('reveal-pulse');
      }
      setAnswerButtonsEnabled(hasRevealedOnce);
    });

    btnTimerStart.addEventListener('click', startModalTimer);
    if (btnTimerPause) btnTimerPause.addEventListener('click', pauseModalTimer);

    if (rulesBtn) rulesBtn.addEventListener('click', openRulesModal);
    if (rulesClose) rulesClose.addEventListener('click', closeRulesModal);
    if (rulesConfirm) rulesConfirm.addEventListener('click', closeRulesModal);
    if (rulesModal) {
      rulesModal.addEventListener('click', (e) => {
        if (e.target === rulesModal) closeRulesModal();
      });
    }
    rulesTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        if (tab.dataset.tab) setRulesTab(tab.dataset.tab);
      });
    });


    function handleCorrect() {
      if (!hasRevealedOnce) return;
      if (currentTurn === 'teamOne') scoreTeamOne += 1;
      else scoreTeamTwo += 1;
      updateScores();
      currentTurn = currentTurn === 'teamOne' ? 'teamTwo' : 'teamOne';
      updateTurnUI();
      if (activeTile) {
        activeTile.classList.add('used');
        activeTile.disabled = true;
        const idx = parseInt(activeTile.dataset.index || '-1', 10);
        if (idx >= 0 && idx < 20) usedTiles[idx] = true;
      }
      saveState();
      closeWordModal();
      checkForGameEnd();
    }

    function handleSkip() {
      if (!hasRevealedOnce) return;
      currentTurn = currentTurn === 'teamOne' ? 'teamTwo' : 'teamOne';
      updateTurnUI();
      if (activeTile) {
        activeTile.classList.add('used');
        activeTile.disabled = true;
        const idx = parseInt(activeTile.dataset.index || '-1', 10);
        if (idx >= 0 && idx < 20) usedTiles[idx] = true;
      }
      saveState();
      closeWordModal();
      checkForGameEnd();
    }

    function startNewGameSameSettings() {
      if (!data) return;
      isGameFinished = false;
      activeTile = null;
      hasRevealedOnce = false;
      isRevealed = false;
      if (modal.classList.contains('active')) {
        closeWordModal();
      }
      if (resultsOverlay) {
        resultsOverlay.classList.remove('active');
        resultsOverlay.setAttribute('aria-hidden', 'true');
      }
      try {
        localStorage.removeItem(GAME_COMPLETED_KEY);
        localStorage.removeItem(getStateKey());
        localStorage.setItem('actwordless_game_data', JSON.stringify(data));
      } catch (e) {
        // Ignore storage errors
      }

      scoreTeamOne = 0;
      scoreTeamTwo = 0;
      currentTurn = 'teamOne';
      updateTurnUI();
      updateScores();

      const selectedIds = Array.isArray(data.categories) ? data.categories : [];
      const usedStore = loadUsedWords();
      wordCategoryIndex = buildWordCategoryIndex(selectedIds);

      let pool = shuffle(getUnusedPool(selectedIds, usedStore));
      if (pool.length === 0) {
        resetUsedForCategories(usedStore, selectedIds);
        saveUsedWords(usedStore);
        pool = shuffle(getUnusedPool(selectedIds, usedStore));
      }
      const picked = pool.slice(0, 20);
      boardWords = picked.map(item => item.word);
      usedTiles = new Array(20).fill(false);
      if (picked.length) {
        markPickedWordsUsed(usedStore, picked);
      }

      boardEl.innerHTML = '';
      for (let i = 0; i < 20; i++) {
        const tile = document.createElement('button');
        tile.type = 'button';
        tile.className = 'tile';
        tile.innerHTML = `
          <div class="tile-content">
            <div class="tile-number">${i + 1}</div>
            <div class="tile-brand">
              <div class="logo-section">
                <div class="logo">
                  <i class="fas fa-theater-masks"></i>
                </div>
                <h1 class="site-title">Act<span>Wordless</span></h1>
              </div>
            </div>
          </div>
        `;
        if (!boardWords[i]) tile.classList.add('muted');
        if (usedTiles[i]) {
          tile.classList.add('used');
          tile.disabled = true;
        }
        tile.addEventListener('click', () => {
          if (!boardWords[i]) return;
          if (tile.classList.contains('used')) return;
          activeTile = tile;
          activeTile.dataset.index = String(i);
          modalWord.textContent = boardWords[i];
          setModalImageForWord(boardWords[i]);
          isRevealed = false;
          hasRevealedOnce = false;
          if (modalPlaceholder) {
            modalPlaceholder.style.display = 'flex';
            modalPlaceholder.classList.remove('compact');
          }
          modalWord.style.display = 'none';
          modalImage.style.display = 'none';
          btnToggleReveal.textContent = 'إظهار';
          setAnswerButtonsEnabled(false);
          btnToggleReveal.classList.add('reveal-pulse');
          resetModalTimer();
          modal.classList.add('active');
          modal.setAttribute('aria-hidden', 'false');
        });
        boardEl.appendChild(tile);
      }
      updateTurnUI();
      updateScores();
      saveState();
    }

    function resetGameAndGoHome() {
      try {
        localStorage.removeItem('actwordless_game_data');
        localStorage.removeItem(getStateKey());
      } catch (e) {
        console.error('Failed to clear game data:', e);
      }
      window.location.href = 'index.html';
    }

    btnCorrect.addEventListener('click', handleCorrect);
    btnSkip.addEventListener('click', handleSkip);
    if (btnNewGame) btnNewGame.addEventListener('click', startNewGameSameSettings);
    if (btnBackHome) btnBackHome.addEventListener('click', resetGameAndGoHome);

    // End/Exit actions
    btnEnd.addEventListener('click', () => {
      const confirmEnd = window.confirm('هل تريد إنهاء اللعبة بالكامل؟ سيتم مسح البيانات الحالية.');
      if (!confirmEnd) return;
      try {
        localStorage.removeItem('actwordless_game_data');
        localStorage.removeItem(getStateKey());
      } catch (e) {
        console.error('Failed to clear game data:', e);
      }
      window.location.href = 'index.html';
    });

    btnExit.addEventListener('click', () => {
      saveState();
      try {
        if (data) {
          localStorage.setItem('actwordless_game_data', JSON.stringify(data));
        }
      } catch (e) {
        // ignore storage errors
      }
      window.location.href = 'index.html';
    });
  </script>
</body>
</html>
